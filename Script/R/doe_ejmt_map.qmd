---
title: "Visualizing Non-Overlapping Disadvantaged Census Tracts: Bolstering CalEnviroScreen Considerations"
author: "Sofia Ingersoll"
format:
  html:
    code-fold: true
    code-summary: "View the code"
embedded-sources: true
output:
  html_document:
    print_df: paged
    toc: yes
    toc_depth: 4
    toc_float: yes
---

```{r set-up, message = FALSE}
library(sf)
#library(sp)
library(tmap)
library(here)
library(stars)
library(terra)
library(raster)
library(maptiles)
library(tidyverse)
library(leaflet)
#library(sfheaders)
#library(ggspatial)
library(tmaptools)
library(osmextract) 
library(RColorBrewer)
```


# Read CalEnviroScreen Data
```{r read_n_wrangle_calenviro}
calenviro <- st_read(here("data","CalEnviroScreen","CES4 Final Shapefile.shp")) %>% 
  janitor::clean_names() %>% 
  st_make_valid()

# housing burden is a good parameter to visualize
# let's get an idea of the bin distribution for plotting
range(calenviro$hous_burd)

# remove the -999.0, that's an NA
calenviro <- calenviro %>% 
  filter(hous_burd != -999.0)

# check! nice!
range(calenviro$hous_burd)
```

# Overview of troubleshooting task below

DOE EJMT geolation data has a length of 0 that indicates there's some issues with the reprojecting the CRS. We'll first look at the structure of the data, check the information provided, validate the geometry and try to transform it to a crs we need to plot.
```
$ geometry  :sfc_GEOMETRY of length 0 - attr(*, "sf_column")= chr "geometry"
 - attr(*, "agr")= Factor w/ 3 levels "constant","aggregate",..: NA NA NA NA NA NA NA NA NA NA ...
  ..- attr(*, "names")= chr [1:50] "geoid" "city" "county" "stateabb" ...
>
```
But doe_ejmt is not happy whenever I transform the CRS and provides this message
```
Error: The shape doe_ejmt only contains empty units (after reprojection).
```

When trying to plot, I found that the raw shapefile is missing information after we filter, 
````
Warning: plotting the first 9 out of 50 attributes; use max.plot = 50 to plot allError in plot_sf(x, ...) : 
  NA value(s) in bounding box. Trying to plot empty geometries?
````

Let's add a bbox for CA. This didn't work either and I am using EPSG:4326.

```{r troubleshooting_workflow}
# Step 1: Read shapefile
doe_ejmt <- st_read(here("data", "DOE_EJ_mapping_tool", "DAC Shapefiles (v2022c).shp"), quiet = TRUE) %>% 
            janitor::clean_names()

# str(doe_ejmt)

# Step 2: Filter for California
doe_ejmt <- doe_ejmt %>% filter(stateabb == "CA")

# Step 3: Validate and fix geometries
doe_ejmt <- st_make_valid(doe_ejmt)
doe_ejmt <- doe_ejmt[!st_is_empty(doe_ejmt), ]


# Step 4: Create a CA bounding box to assign to the data
calenviro <- st_transform(calenviro,  4326) %>% 
  st_make_valid()

ca_bbox <- st_bbox(calenviro)

doe_ejmt <- st_transform(doe_ejmt, 4326)

attr(st_geometry(doe_ejmt), "bbox") <- ca_bbox

plot(st_geometry(doe_ejmt))
```


```{r doe_ejmt_map}
# we'll break housing burden into quantiles
bins <- seq(0, 100, by = 25)

# i want a map will all the data layered for for selection against calenviro
tmap_mode(mode = "view")

tm_shape(calenviro) +
  
  tm_basemap(leaflet::providers$OpenStreetMap) +
  
  tm_polygons(col = 'hous_burd',
              palette = 'plasma',
              style = 'fixed',
              breaks = bins) +
  
  tm_shape(doe_ejmt) +
  
  # areas with overlap are made to be white,
  # as to "white out" areas not of interest  
  # the only visible regions are where the data do no overlap 
  tm_bubbles(col = 'white',
             size = .1,
             alpha = 0.5,
             palette = "plasma",
             border.col = 'white'
             ) 
```


